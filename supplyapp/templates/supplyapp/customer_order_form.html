{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Place Customer Order</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', sans-serif;
    }
    .container {
      max-width: 750px;
      margin-top: 60px;
    }
    .card {
      border: none;
      border-radius: 14px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      background-color: white;
      padding: 35px 30px;
    }
    h3 {
      color: #0d6efd;
      font-weight: 600;
      text-align: center;
      margin-bottom: 25px;
    }
    .price-label {
      font-weight: 600;
      color: green;
      margin-bottom: 10px;
      display: block;
    }
  </style>
</head>

<body>

<div class="container">
  <div class="card">

    <h3>Place Customer Order</h3>

    <!-- Order form -->
    <form method="POST" action="{% url 'customer_order_form' %}">
      {% csrf_token %}

      <!-- Customer Name (prefilled with logged-in email) -->
      <div class="mb-3">
        <label>Customer Name</label>
        <input type="text"
               name="customer_name"
               value="{{ customer_name }}"
               class="form-control"
               required>
      </div>

      <!-- Distributor -->
      <div class="mb-3">
        <label>Distributor</label>
        <select name="distributor" class="form-select" id="distSelect" required>
          <option value="">Select Distributor</option>
          {% for d in distributors %}
            <option value="{{ d.id }}" {% if d.id == selected_dist_id %}selected{% endif %}>
              {{ d.name }} ({{ d.region }})
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Finished Product -->
      <div class="mb-3">
        <label>Finished Product</label>
        <select name="finished_product" id="productSelect" class="form-select" required>
          <option value="">Select Finished Product</option>
          {% for f in finished_products %}
            <option value="{{ f.finished_id }}">
              {{ f.blend_name }} (Price: ${{ f.unit_price }}, Stock: {{ f.quantity }})
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Unit Price label + hidden field -->
      <label id="priceLabel" class="price-label"></label>
      <input type="hidden" id="unitPriceValue">

      <!-- Quantity -->
      <div class="mb-3">
        <label>Quantity</label>
        <select name="quantity" id="qtyInput" class="form-select" required>
          <option value="">Select Quantity</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
        </select>
      </div>

      <!-- Total Price (readonly) -->
      <div class="mb-3">
        <label>Total Price</label>
        <input type="text" id="totalPrice" class="form-control" readonly>
      </div>

      <!-- Address -->
      <div class="mb-3">
        <label>Address</label>
        <textarea name="address" class="form-control" required>{{ address }}</textarea>
      </div>

      <!-- Main submit -->
      <button type="submit" class="btn btn-primary w-100">Submit Order</button>
    </form>

    <!-- Extra actions -->
    <div class="mt-3 d-grid gap-2">
      <!-- Customer order list (previous orders for this customer) -->
      <a href="{% url 'customer_order_details'%}" class="btn btn-success">
        My Orders
      </a>
      <!-- Logout for customer -->
      <a href="{% url 'logout' %}" class="btn btn-outline-danger">
        Logout
      </a>
    </div>

  </div>
</div>

<script>
  const distSelect      = document.getElementById('distSelect');
  const productSelect   = document.getElementById('productSelect');
  const qtySelect       = document.getElementById('qtyInput');
  const unitPriceInput  = document.getElementById('unitPriceValue');
  const totalPriceInput = document.getElementById('totalPrice');
  const priceLabel      = document.getElementById('priceLabel');

  // Reload page when distributor changes so that finished product list is filtered
  distSelect.addEventListener('change', function () {
      const dist = this.value;
      const name = document.querySelector('input[name="customer_name"]').value;
      const qty  = qtySelect.value;
      const addr = document.querySelector('textarea[name="address"]').value;

      window.location.href =
          `?distributor=${dist}&customer_name=${encodeURIComponent(name)}&quantity=${encodeURIComponent(qty)}&address=${encodeURIComponent(addr)}`;
  });

  // When product changes, get price and update label + total price
  productSelect.addEventListener('change', function () {
      const productId = this.value;
      if (!productId) return;

      fetch(`/get-product-details/?product_id=${productId}`)
          .then(response => response.json())
          .then(data => {
              if (!data || typeof data.unit_price === 'undefined') {
                  priceLabel.textContent = "";
                  unitPriceInput.value = "";
                  totalPriceInput.value = "";
                  return;
              }

              priceLabel.textContent = `Price: $${data.unit_price.toFixed(2)} per bag`;
              unitPriceInput.value = data.unit_price;

              const qty = parseInt(qtySelect.value) || 0;
              totalPriceInput.value = (qty * data.unit_price).toFixed(2);
          });
  });

  // Recalculate total when quantity changes
  qtySelect.addEventListener('change', function () {
      const qty       = parseInt(this.value) || 0;
      const unitPrice = parseFloat(unitPriceInput.value) || 0;
      totalPriceInput.value = (qty * unitPrice).toFixed(2);
  });
</script>

</body>
</html>
